#!/bin/bash

# bluetoothctl non-interactive mode is broken in v5.86+, pipe commands instead
# https://github.com/bluez/bluez/issues/1896
# TODO: check if this workaround is still needed when updating this script
btctl() {
    echo "$*" | bluetoothctl 2>/dev/null
}

# Get bluetooth power state
bt_power=$(btctl show | grep "Powered:" | awk '{print $2}')

# Build menu
build_menu() {
    if [ "$bt_power" != "yes" ]; then
        echo "[Power: OFF] Turn on"
        return
    fi

    # Get connected devices
    connected=$(btctl devices Connected | grep "^Device" | cut -d' ' -f2)

    # Count name occurrences to detect duplicates
    all_devices=$(btctl devices Paired | grep "^Device")

    # Format a device line
    format_device() {
        local mac="$1" name="$2" paired="$3"
        local info icon status type_icon suffix dupes

        info=$(btctl info "$mac")
        icon=$(echo "$info" | grep "Icon:" | awk '{print $2}')

        if echo "$connected" | grep -q "$mac"; then
            status="*"
        else
            status=" "
        fi

        case "$icon" in
            audio-headset|audio-headphones) type_icon="H" ;;
            audio-card) type_icon="S" ;;
            input-gaming) type_icon="G" ;;
            computer) type_icon="C" ;;
            phone) type_icon="P" ;;
            *) type_icon="-" ;;
        esac

        if [ "$paired" = "no" ]; then
            echo "[ ?] $name (${mac: -5})"
            return
        fi

        dupes=$(echo "$all_devices" | grep -c " $name$")
        if [ "$dupes" -gt 1 ]; then
            suffix=" (${mac: -5})"
        else
            suffix=""
        fi

        echo "[$status$type_icon] $name$suffix"
    }

    # Connected devices first
    while IFS= read -r line; do
        [ -z "$line" ] && continue
        mac=$(echo "$line" | cut -d' ' -f2)
        echo "$connected" | grep -q "$mac" || continue
        name=$(echo "$line" | cut -d' ' -f3-)
        format_device "$mac" "$name" yes
    done < <(btctl devices Paired | grep "^Device")

    # Then disconnected paired devices
    while IFS= read -r line; do
        [ -z "$line" ] && continue
        mac=$(echo "$line" | cut -d' ' -f2)
        echo "$connected" | grep -q "$mac" && continue
        name=$(echo "$line" | cut -d' ' -f3-)
        format_device "$mac" "$name" yes
    done < <(btctl devices Paired | grep "^Device")

    # Unpaired but known devices
    paired_macs=$(btctl devices Paired | grep "^Device" | cut -d' ' -f2)
    while IFS= read -r line; do
        [ -z "$line" ] && continue
        mac=$(echo "$line" | cut -d' ' -f2)
        echo "$paired_macs" | grep -q "$mac" && continue
        name=$(echo "$line" | cut -d' ' -f3-)
        format_device "$mac" "$name" no
    done < <(btctl devices | grep "^Device")

    echo "[Scan] Search for devices"
    echo "[Power: ON] Turn off"
}

# Get MAC from name (with optional short suffix)
get_mac() {
    local search="$1"
    # Check if has suffix like "(4E:75)"
    if echo "$search" | grep -qE '\([0-9A-F:]{5}\)$'; then
        suffix=$(echo "$search" | grep -oE '\([0-9A-F:]{5}\)$' | tr -d '()')
        btctl devices | grep "^Device" | grep "$suffix" | head -1 | cut -d' ' -f2
    else
        btctl devices | grep "^Device" | grep " $search$" | head -1 | cut -d' ' -f2
    fi
}

# Handle selection
handle_selection() {
    selection="$1"

    case "$selection" in
        "[Power: ON] Turn off")
            btctl power off
            notify-send "Bluetooth" "Powered off"
            ;;
        "[Power: OFF] Turn on")
            btctl power on
            notify-send "Bluetooth" "Powered on"
            ;;
        "[Scan] Search for devices")
            notify-send -t 5000 "Bluetooth" "Scanning for 5 seconds..."
            (echo "scan on"; sleep 5; echo "scan off") | bluetoothctl >/dev/null 2>&1
            exec "$0"  # Restart menu
            ;;
        "["*"] "*)
            # Extract name and status from selection
            name=$(echo "$selection" | sed 's/\[.*\] //')
            status=$(echo "$selection" | grep -o '^\[[^]]*\]' | tr -d '[]')
            mac=$(get_mac "$name")

            # Clean name for display (remove suffix)
            display_name=$(echo "$name" | sed 's/ ([0-9A-F:]\{5\})$//')

            if [ -z "$mac" ]; then
                notify-send "Bluetooth" "Device not found"
                exit 1
            fi

            # Check if connected (has * in status)
            if echo "$status" | grep -q '\*'; then
                # Connected - show submenu
                action=$(printf "Disconnect\nRemove (unpair)" | tofi --prompt-text "$display_name: ")
                case "$action" in
                    "Disconnect")
                        btctl disconnect "$mac"
                        notify-send "Bluetooth" "Disconnected from $display_name"
                        ;;
                    "Remove (unpair)")
                        btctl remove "$mac"
                        notify-send "Bluetooth" "Removed $display_name"
                        ;;
                esac
            elif echo "$status" | grep -q '?'; then
                # Unpaired device - offer to pair
                action=$(printf "Pair & Connect\nPair only" | tofi --prompt-text "$display_name: ")
                case "$action" in
                    "Pair & Connect")
                        notify-send "Bluetooth" "Pairing with $display_name..."
                        btctl pair "$mac"
                        btctl trust "$mac"
                        btctl connect "$mac"
                        notify-send "Bluetooth" "Connected to $display_name"
                        ;;
                    "Pair only")
                        btctl pair "$mac"
                        btctl trust "$mac"
                        notify-send "Bluetooth" "Paired with $display_name"
                        ;;
                esac
            else
                # Paired but not connected - connect
                notify-send "Bluetooth" "Connecting to $display_name..."
                result=$(btctl connect "$mac")
                if echo "$result" | grep -q "Connection successful"; then
                    notify-send "Bluetooth" "Connected to $display_name"
                else
                    notify-send "Bluetooth" "Failed to connect to $display_name"
                fi
            fi
            ;;
    esac
}

# Main
selection=$(build_menu | tofi --prompt-text "bt: ")
[ -n "$selection" ] && handle_selection "$selection"
