#!/bin/bash
# tofi-cliphist with image and text preview support
# Requires: tofi (with --stream-events), cliphist, imv, alacritty, bat, glow, jq, wl-copy

PREVIEW_IMG="/tmp/tofi-cliphist-preview.png"
PREVIEW_TXT="/tmp/tofi-cliphist-preview.txt"
PREVIEW_PLACEHOLDER="/tmp/tofi-cliphist-placeholder.png"
TOFI_BIN="${TOFI_BIN:-tofi}"

# Create 1x1 black PNG placeholder
echo 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=' | base64 -d > "$PREVIEW_PLACEHOLDER"
PREVIEW_GAP=20

imv_pid=""
text_preview_pid=""
preview_x=""
preview_y=""
preview_w=""
preview_h=""

cleanup() {
    [ -n "$imv_pid" ] && kill "$imv_pid" 2>/dev/null
    [ -n "$text_preview_pid" ] && kill "$text_preview_pid" 2>/dev/null
    rm -f "$PREVIEW_IMG" "$PREVIEW_TXT" "$PREVIEW_PLACEHOLDER"
    # Clean up the for_window rule
    swaymsg "for_window [app_id=cliphist-preview] floating enable" 2>/dev/null
}
trap cleanup EXIT

# Get clipboard list with IDs
clipboard_data=$(cliphist list)

# Launch tofi with streaming events
exec 3< <(echo "$clipboard_data" | sed 's/\t/ /' | "$TOFI_BIN" --prompt-text "clip: " --stream-events 2>&1)

selected=""
while IFS= read -r line <&3; do
    if [[ "$line" == "{"* ]]; then
        # JSON event from tofi
        event=$(echo "$line" | jq -r '.event // empty')

        case "$event" in
            open)
                # Calculate preview position from tofi window geometry
                win_x=$(echo "$line" | jq -r '.window.x')
                win_y=$(echo "$line" | jq -r '.window.y')
                win_w=$(echo "$line" | jq -r '.window.width')
                win_h=$(echo "$line" | jq -r '.window.height')
                out_w=$(echo "$line" | jq -r '.output.width')

                # Preview fills remaining space to the right of tofi
                preview_x=$(( win_x + win_w + PREVIEW_GAP ))
                preview_w=$(( out_w - preview_x - PREVIEW_GAP ))
                preview_h=$win_h
                preview_y=$win_y

                # If not enough space on right, use left side
                if (( preview_w < 200 )); then
                    preview_w=$(( win_x - PREVIEW_GAP * 2 ))
                    preview_x=$PREVIEW_GAP
                fi

                # Set up the window rule now, before any preview is shown
                # Note: order matters - float first, then resize, then move
                swaymsg "for_window [app_id=cliphist-preview] floating enable; \
                         for_window [app_id=cliphist-preview] resize set $preview_w $preview_h; \
                         for_window [app_id=cliphist-preview] move absolute position $preview_x $preview_y" 2>/dev/null

                # Spawn placeholder black background (stays open entire session)
                imv -i "cliphist-preview" "$PREVIEW_PLACEHOLDER" &
                imv_pid=$!
                ;;
            select)
                value=$(echo "$line" | jq -r '.value // empty')

                # Kill any text preview (imv stays open)
                [ -n "$text_preview_pid" ] && kill "$text_preview_pid" 2>/dev/null
                text_preview_pid=""

                # Check if this is an image entry
                if [[ "$value" == *"[[ binary data"*"png"* ]] || \
                      [[ "$value" == *"[[ binary data"*"jpg"* ]] || \
                      [[ "$value" == *"[[ binary data"*"jpeg"* ]] || \
                      [[ "$value" == *"[[ binary data"*"webp"* ]] || \
                      [[ "$value" == *"[[ binary data"*"gif"* ]]; then
                    # Extract image from cliphist and update imv
                    echo "$value" | sed 's/ /\t/' | cliphist decode > "$PREVIEW_IMG" 2>/dev/null
                    if [ -s "$PREVIEW_IMG" ]; then
                        imv-msg "$imv_pid" open "$PREVIEW_IMG"
                        imv-msg "$imv_pid" goto -1
                    fi
                elif [[ "$value" != *"[[ binary data"* ]]; then
                    # Reset imv to placeholder
                    imv-msg "$imv_pid" close all
                    imv-msg "$imv_pid" open "$PREVIEW_PLACEHOLDER"

                    # Text entry - extract the actual text (remove the ID prefix)
                    text=$(echo "$value" | sed 's/ /\t/' | cliphist decode 2>/dev/null)
                    echo "$text" > "$PREVIEW_TXT"

                    alacritty --class "cliphist-preview" -e micro -softwrap true "$PREVIEW_TXT" &
                    text_preview_pid=$!
                fi
                ;;
            submit)
                selected=$(echo "$line" | jq -r '.value // empty')
                ;;
        esac
    fi
done

exec 3<&-

# If we got a selection, decode and copy to clipboard
if [ -n "$selected" ]; then
    echo "$selected" | sed 's/ /\t/' | cliphist decode | wl-copy
fi
